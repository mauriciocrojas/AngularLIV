<div class="usuarios-container">
  <h2>Gesti√≥n de Usuarios</h2>
  <button (click)="exportarUsuariosExcel()">üì• Exportar a Excel</button>
  <br>
  <!-- Loading -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div *ngIf="!loading">
    <!-- Tabla de usuarios -->
    <div class="tabla-scroll">
      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Nombre</th>
            <th>Email</th>
            <th>Confirmaci√≥n</th>
            <th>Habilitaci√≥n</th>
            <th>Historia Cl√≠nica</th> <!-- Nueva columna -->
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of usuarios">
            <td>{{ user.tipo_usuario }}</td>
            <td>{{ user.nombre }} {{ user.apellido }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.confirmado ? 'S√≠' : 'No' }}</td>
            <td>
              <button *ngIf="user.tipo_usuario === 'especialista'" (click)="cambiarEstado(user)">
                {{ user.confirmado ? 'Inhabilitar' : 'Habilitar' }}
              </button>
            </td>
            <td>
              <!-- Nuevo bot√≥n para ver historia cl√≠nica -->
              <button *ngIf="user.tipo_usuario === 'paciente'" (click)="verHistoriaClinica(user.id, user.nombre + ' ' + user.apellido)">
                Ver Historia
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="mensaje2" class="mensaje">{{ mensaje2 }}</div>

    <br><br>
    <h3>Crear Nuevo Usuario</h3>
    <div *ngIf="mensaje" class="mensaje">{{ mensaje }}</div>

    <!-- Selecci√≥n de tipo de usuario con im√°genes -->
    <div *ngIf="!nuevoUsuario.tipo_usuario" class="tipo-seleccion">
      <strong>Seleccion√° el tipo de usuario:</strong>
      <div class="tipo-opciones">
        <div (click)="nuevoUsuario.tipo_usuario = 'paciente'" class="opcion">
          <img src="assets/paciente.png" alt="Paciente">
          <span>Paciente</span>
        </div>
        <div (click)="nuevoUsuario.tipo_usuario = 'especialista'" class="opcion">
          <img src="assets/especialista.png" alt="Especialista">
          <span>Especialista</span>
        </div>
        <div (click)="nuevoUsuario.tipo_usuario = 'administrador'" class="opcion">
          <img src="assets/admin.png" alt="Administrador">
          <span>Administrador</span>
        </div>
      </div>
    </div>

    <form *ngIf="nuevoUsuario.tipo_usuario" class="form">
      <button type="button" class="btn-volver" (click)="nuevoUsuario.tipo_usuario = ''">‚Üê Volver a elegir tipo</button>

      <fieldset>
        <legend>Datos Generales</legend>
        <div class="form-group">
          <input name="nombre" type="text" placeholder="Nombre" [(ngModel)]="nuevoUsuario.nombre" />
          <input name="apellido" type="text" placeholder="Apellido" [(ngModel)]="nuevoUsuario.apellido" />
          <input name="edad" type="number" placeholder="Edad" [(ngModel)]="nuevoUsuario.edad" />
          <input name="dni" type="text" placeholder="DNI" [(ngModel)]="nuevoUsuario.dni" />
        </div>
      </fieldset>

      <fieldset>
        <legend>Acceso</legend>
        <div class="form-group">
          <input name="email" type="email" placeholder="Email" [(ngModel)]="nuevoUsuario.email" />
          <input name="password" type="password" placeholder="Password" [(ngModel)]="nuevoUsuario.password" />
          <input type="file" multiple (change)="onFilesSelected($event)" />
          <label>Seleccionar {{ nuevoUsuario.tipo_usuario === 'paciente' ? '2 im√°genes' : '1 imagen' }}</label>
        </div>
      </fieldset>

      <fieldset *ngIf="nuevoUsuario.tipo_usuario === 'especialista'">
        <legend>Datos del Especialista</legend>
        <div class="form-group">
          <label>Especialidad existente:</label>
          <select name="especialidadSeleccionada" [(ngModel)]="nuevoUsuario.especialidadSeleccionada">
            <option value="" disabled selected>Seleccionar especialidad</option>
            <option *ngFor="let esp of especialidades" [value]="esp">{{ esp }}</option>
          </select>
          <input name="nuevaEspecialidad" type="text" placeholder="Especialidad adicional"
            [(ngModel)]="nuevoUsuario.nuevaEspecialidad" />
        </div>
      </fieldset>

      <fieldset *ngIf="nuevoUsuario.tipo_usuario === 'paciente'">
        <legend>Datos del Paciente</legend>
        <div class="form-group">
          <label>Obra Social:</label>
          <select name="obra_social" [(ngModel)]="nuevoUsuario.obra_social">
            <option value="" disabled selected>Seleccionar obra social</option>
            <option value="Swiss Medical">Swiss Medical</option>
            <option value="Galeno">Galeno</option>
            <option value="OSDE">OSDE</option>
          </select>
        </div>
      </fieldset>

      <button type="button" (click)="crearUsuario()">Crear Usuario</button>
    </form>

    <div class="btn-container">
      <button routerLink="/home">Volver</button>
    </div>
  </div>
</div>

<!-- Modal para Historia Cl√≠nica -->
<div *ngIf="showHistoriaClinicaModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Historia Cl√≠nica de {{ selectedPatientName }}</h3>
    <button class="modal-close-button" (click)="closeHistoriaClinicaModal()">X</button>

    <div *ngIf="selectedHistoriaClinica.length > 0; else noHistoria">
      <div *ngFor="let historia of selectedHistoriaClinica" class="historia-item">
        <h4>Turno - {{ historia.fecha_turno | date:'short' }}</h4>
        <p><strong>Especialista:</strong> {{ historia.especialista_nombre || 'N/A' }}</p>
        <p><strong>Especialidad:</strong> {{ historia.especialidad || 'N/A' }}</p>
        <p><strong>Altura:</strong> {{ historia.altura || 'N/A' }}</p>
        <p><strong>Peso:</strong> {{ historia.peso || 'N/A' }}</p>
        <p><strong>Temperatura:</strong> {{ historia.temperatura || 'N/A' }}</p>
        <p><strong>Presi√≥n:</strong> {{ historia.presion || 'N/A' }}</p>
        <div *ngIf="historia.datos_dinamicos">
          <h5>Datos Adicionales:</h5>
          <ul>
            <li *ngFor="let key of getObjectKeys(historia.datos_dinamicos)">
              <strong>{{ key }}:</strong> {{ historia.datos_dinamicos[key] }}
            </li>
          </ul>
        </div>
      </div>
    </div>
    <ng-template #noHistoria>
      <p>No se encontraron historias cl√≠nicas para este paciente.</p>
    </ng-template>
  </div>
</div>
